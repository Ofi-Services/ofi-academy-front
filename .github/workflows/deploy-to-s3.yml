name: Deploy React App to S3 (Production Environment)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run build validation
        run: |
          echo "üî® Starting build process..."
          echo "üìÇ Current directory: $(pwd)"
          echo "üì¶ Node version: $(node --version)"
          echo "üîß PNPM version: $(pnpm --version)"
          echo ""
          echo "Building project..."
          pnpm build 2>&1 | tee build.log
          echo "‚úÖ Build completed successfully!"

      - name: Build status check
        if: success()
        run: |
          echo "üéâ Build validation passed!"
          echo "‚úÖ Build: successful"
          echo ""
          echo "This PR is ready for review and merge."

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: build.log

      - name: Build failed notification
        if: failure()
        run: |
          echo "‚ùå Build validation failed!"
          echo ""
          echo "The build process encountered errors."
          echo "Check the 'Actions' tab and download 'build-logs' artifact for detailed error information."
          echo ""
          echo "Or check the build output above in the 'Run build validation' step."
          echo "Please fix the build issues before merging to main."
          exit 1

      - name: Deploy to S3
        uses: jakejarvis/s3-sync-action@v0.5.1
        with:
          args: --delete
        env:
          AWS_S3_BUCKET: academy.ofiservices.com
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          SOURCE_DIR: dist